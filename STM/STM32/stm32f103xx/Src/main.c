/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */
#include <stm32f103xx.h>
#include <gpiox_driver.h>
#include <timerx_driver.h>
#include <lcd_driver.h>
#include <rcc_driver.h>
void SysClock_Init(void);
void LCD(void);

GPIO_Handle_t sda, scl;
RCC_Handle_t hRcc;
LCD_Handle_t lcd;
TIMER2_5_Handle_t Timer2;
I2C_Handle_t i2c1;

int main(void) {
    SysClock_Init(); //72Mhz
    LCD();
    Timer2 = TIMER2_5_Init_Delay(TIMER2, 719999);


//    lcd_i2c_send(&i2c1, 0x27, "h3h3");
    lcd_i2c_msg(&i2c1, 0x27, 1, 2, "hehehehee");
    lcd_i2c_msg(&i2c1, 0x27, 2, 1, "Cuong");

    for (;;) {
        // Có thể thêm code kiểm tra trạng thái LCD định kỳ
    }
}

void SysClock_Init(void) {

	hRcc.Config.clk_src = RCC_CLK_PLL;       // Sử dụng PLL làm nguồn xung chính
	hRcc.Config.pll_src = RCC_PLL_SRC_HSE; // Chọn HSE làm nguồn đầu vào cho PLL
	hRcc.Config.pll_mul = RCC_PLL_MUL_9;            // Hệ số nhân PLL = 9
	hRcc.Config.ahb_prescaler = RCC_AHB_DIV_1;      // AHB không chia
	hRcc.Config.apb1_prescaler = RCC_APB_DIV_2;     // APB1 chia 2
	hRcc.Config.apb2_prescaler = RCC_APB_DIV_1;     // APB2 không chia

	// Gọi hàm cấu hình đồng hồ
	RCC_ConfigClock(&hRcc);

}
void LCD(void) {
	sda = GPIO_Init(GPIOB, GPIO_PIN_7, GPIO_MODE_OUTPUT_10MHz, GPIO_CNF_AF_OD);
	scl = GPIO_Init(GPIOB, GPIO_PIN_6, GPIO_MODE_OUTPUT_10MHz, GPIO_CNF_AF_OD);
	i2c1 = I2C_Init(
	I2C1,                        // Instance: phần cứng I2C1
			100000,                     // ClockSpeed: 100kHz
			I2C_ADDRESSINGMODE_7BIT,    // AddressingMode: 7-bit
			0x00,                       // OwnAddress: địa chỉ I2C
			I2C_ACK_ENABLE,             // Acknowledge: bật ACK
			I2C_DUTYCYCLE_2             // DutyCycle: chế độ thường
			);

	lcd_i2c_init(&i2c1, 0x27);
}

