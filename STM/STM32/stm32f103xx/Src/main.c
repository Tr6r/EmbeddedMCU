/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */
#include <stm32f103xx.h>
#include <gpiox_driver.h>
#include <L9110_driver.h>
#include <encoder_driver.h>
#include <rcc_driver.h>

void SysClock_Init(void);
void l9110_Init(void);
void Encoder_Init(void);
GPIO_Handle_t PwmB, PwmA, EnA, EnB;
RCC_Handle_t hRcc;
L9110_Handle_t l9110;
ENC_Handle_t hEnc;

//I2C_Handle_t I2c1;
TIMER2_5_Handle_t Timer2, Timer3, TimEnc;
int16_t count_Enc =0;
int main(void) {
	SysClock_Init();

	Timer3 = TIMER2_5_Init_Delay(TIMER3, 719999);
	Encoder_Init();
	l9110_Init();
//	L9110_Straight(&l9110, L9110_DIRECTION_FORWARD, 90);  // PWM 80%

	for (;;) {
//		count = ENC_Read(&hEnc);
//		count_Enc = TIMER4->CNT;

		L9110_Straight_Dis(&l9110, L9110_DIRECTION_FORWARD, 80 ,TIMER4 ,1200);
		TIMER2_5_Delay(&Timer3, 1999);
//
//		L9110_Stop(&l9110);
//
//		L9110_Straight(&l9110, L9110_DIRECTION_REVERSE, 90);  // PWM 80%
//
//		TIMER2_5_Delay(&Timer3, 1999);
//
//		L9110_Stop(&l9110);
//		TIMER2_5_Delay(&Timer3, 999);

	}
}
void l9110_Init() {
	PwmB = GPIO_Init(GPIOA, GPIO_PIN_1, GPIO_MODE_OUTPUT_10MHz, GPIO_CNF_AF_PP);
	PwmA = GPIO_Init(GPIOA, GPIO_PIN_0, GPIO_MODE_OUTPUT_10MHz, GPIO_CNF_AF_PP);
	Timer2.Instance = TIMER2;
	Timer2.Config.Feature = TIM_FEATURE_PWM;
	Timer2.Config.Prs = 71;
	Timer2.Config.Arr = 100;
	Timer2.Config.Channel = TIM_CHANNEL_1;
	Timer2.Config.OCMode = TIM_OCMODE_PWM1;
	TIM2_5_Init(&Timer2);
	l9110.PWMB_Pin = &PwmB;
	l9110.PWMA_Pin = &PwmA;
	l9110.hTIM = &Timer2;

}
void SysClock_Init(void) {

	hRcc.Config.clk_src = RCC_CLK_PLL;       // Sử dụng PLL làm nguồn xung chính
	hRcc.Config.pll_src = RCC_PLL_SRC_HSE; // Chọn HSE làm nguồn đầu vào cho PLL
	hRcc.Config.pll_mul = RCC_PLL_MUL_9;            // Hệ số nhân PLL = 9
	hRcc.Config.ahb_prescaler = RCC_AHB_DIV_1;      // AHB không chia
	hRcc.Config.apb1_prescaler = RCC_APB_DIV_2;     // APB1 chia 2
	hRcc.Config.apb2_prescaler = RCC_APB_DIV_1;     // APB2 không chia

	// Gọi hàm cấu hình đồng hồ
	RCC_ConfigClock(&hRcc);
//	RCC->CFGR &= ~(0x7 << 24);
//	RCC->CFGR |= (0x4 << 24);

}
void Encoder_Init(void) {
	EnA = GPIO_Init(GPIOB, GPIO_PIN_6, GPIO_MODE_INPUT,
			GPIO_CNF_INPUT_FLOATING);
	EnB = GPIO_Init(GPIOB, GPIO_PIN_7, GPIO_MODE_INPUT,
			GPIO_CNF_INPUT_FLOATING);
	TimEnc.Instance = TIMER4;
	TimEnc.Config.Feature = TIM_FEATURE_ENCODER_MODE;
	TimEnc.Config.Mode = TIM_MODE_UP;
	TimEnc.Config.SMode = TIM_ENCODER_MODE_3;
	TimEnc.Config.Prs = 0;
	TimEnc.Config.Arr = 65535;
	TimEnc.Config.Channel = TIM_CHANNEL_1;
	TIM2_5_Init(&TimEnc);

}

